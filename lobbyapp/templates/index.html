{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>RetroArch Lobby Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link
    rel="stylesheet"
    href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css"
    integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ"
    crossorigin="anonymous">
<link rel="icon" href="https://www.libretro.com/wp-content/uploads/2016/01/ic_launcher.png" sizes="32x32"/>
<link rel="icon" href="https://www.libretro.com/wp-content/uploads/2016/01/ic_launcher.png" sizes="192x192"/>
<link rel="apple-touch-icon-precomposed" href="https://www.libretro.com/wp-content/uploads/2016/01/ic_launcher.png"/>
<script src="https://unpkg.com/vue"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
</head>
<body>

    {% verbatim %}
    <div class="container" id="app">
        <div class="jumbotron">
            <h1 class="display-4">RetroArch Lobby Browser</h1>
            <p class="lead">Currently available netplay rooms in <a href="http://libretro.com">RetroArch</a>.</p>
            <hr class="my-4">
            <p class="lead">
                <a class="btn btn-primary btn-lg"
                    href="https://www.libretro.com/" role="button">RetroArch</a>
                <a class="btn btn-info btn-lg"
                    href="https://www.youtube.com/watch?v=oh7hhoOBg54" role="button">How to Join</a>
                <a class="btn btn-info btn-lg"
                    href="https://www.youtube.com/watch?v=n6aF0wNcm7E" role="button">How to Host</a>
            </p>
        </div>

        <table class="table" v-if="entries.length"><thead><tr>
            <th>Nickname</th><th>Game</th><th>Core</th><th>Password?</th><th>Created</th>
        </tr></thead><tbody>
            <tr v-for="entry in entries">
                <th>{{ entry.fields.username }}</th>
                <td>{{ entry.fields.game_name }}</td>
                <td>{{ entry.fields.core_name }} {{ entry.fields.core_version }}</td>
                <td>{{ entry.fields.has_password?"Yes":"No" }}</td>
                <td>{{ moment(entry.fields.created).fromNow() }}</td>
            </tr>
        </tbody></table>

        <div v-else class="alert alert-info" role="alert">There are currently no lobbies open.</div>


    </div>
    {% endverbatim %}
    <script>
    //TODO: move this to an external file
    var apiURL = "/list/"

    /**
     * How often to refresh the list in miliseconds
     * @type int
     */
    var refereshInterval = 3000

    function notify($message) {
        // Let's check if the browser supports notifications
        if ("Notification" in window) {
            var notificationOptions={
                requireInteraction : true,
                icon:"https://www.libretro.com/wp-content/uploads/2016/01/ic_launcher.png"
            };

            if (Notification.permission === "granted") {
                var notification = new Notification($message,notificationOptions)
            }

            // Otherwise, we need to ask the user for permission
            else if (Notification.permission !== "denied") {
                Notification.requestPermission(function (permission) {
                    if (permission === "granted") {
                        var notification = new Notification($message,$notificationOptions);
                    }
                });
            }
        }
    }


    var app = new Vue({
        el: '#app',
        data: {
            message: 'Hello Vue!',
            entries: {}
        },
        created: function () {
            this.fetchData()
            setInterval(function () {
                this.fetchData();
            }.bind(this), refereshInterval);
        },
        methods:{
            fetchData: function () {
                var xhr = new XMLHttpRequest(true)
                var self = this
                xhr.open('GET', apiURL)
                xhr.onload = function () {
                    self.oldEntries = self.entries;
                    self.entries = JSON.parse(xhr.responseText)

                    //test if we have new entries
                    if("some" in self.oldEntries){
                        self.entries.forEach(function(newEntry){
                            if(!(self.oldEntries.some(function(oldEntry){
                                return (
                                    oldEntry.pk == newEntry.pk &&
                                    oldEntry.fields.username == newEntry.fields.username &&
                                    oldEntry.fields.game_name == newEntry.fields.game_name &&
                                    oldEntry.fields.game_crc == newEntry.fields.game_crc &&
                                    oldEntry.fields.core_name == newEntry.fields.core_name &&
                                    oldEntry.fields.core_version == newEntry.fields.core_version
                                )
                            }))){
                                //notify on new lobby
                                notify(
                                    newEntry.fields.username + " Wants to play " +
                                    newEntry.fields.game_name + " on  " +
                                    newEntry.fields.core_name
                                )
                            }
                        })
                    }
                }
                xhr.send()
            },
            moment: moment
        }
    })
    </script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
    <script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"
        integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
        crossorigin="anonymous"></script>
</body>
</html>
